# Redis雪崩的解决方案

相对来说，考虑的比较完善的一套方案，分为事前、事中、事后三个层次去思考再怎么来应对缓存雪崩的场景。

## 事前解决方案

发生缓存雪崩之前，怎么去避免 redis 彻底挂掉：

- redis本身的高可用性、复制、主从架构，操作主节点，读写，数据同步到从节点，一旦主节点挂掉，从节点跟上。
- 双机房部署，一套 redis cluster，部分机器在一个机房，另一部分机器在另外一个机房。
- 还有一种部署方式，两套 redis cluster，两套 redis cluster 之间做一个数据的同步，redis 集群是可以搭建成树状的结构的。



## 事中解决方案

redis cluster 已经彻底崩溃了，已经开始大量的访问无法访问到 redis 了。

### ehcache 本地缓存

多级缓存架构，的优点一个是本地缓存应对零散的 redis 中数据被清除掉的现象，另外一个主要是预防 redis 彻底崩溃。

多台机器上部署的缓存服务实例的内存中，还有一套 ehcache 的缓存，还能支撑一阵。

### 对 redis 访问的资源隔离

对 redis 访问使用 hystrix 进行隔离，防止自己资源大量阻塞在访问 redis 上。

### 对源服务访问的限流以及资源隔离

同上，防止自己资源大量阻塞在访问源服务上，同时 hystrix 在资源隔离时也做到了限流。



## 事后解决方案

- 如果redis数据可以恢复，则快速恢复后重启。
- 如果redis数据丢失或者数据过旧，快速缓存预热，重启redis。

由于事中做了限流与隔离，缓存服务不会被打死，通过熔断策略 和 half-open 策略， 可以自动恢复对 redis 的访问，发现 redis 可以访问了，就自动恢复了。